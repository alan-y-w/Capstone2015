/*
 * test.c
 *
 *  Created on: 2015-02-09
 *      Author: Amanjit
 */

#include <stdio.h>
#include "platform.h"
#include "xtft.h"

/************************** Constant Definitions ****************************/
#define DISPLAY_COLUMNS  640
#define DISPLAY_ROWS     480

volatile unsigned int * FrameBuffer0 = (unsigned int *)0x80000000;
volatile unsigned int * FrameBuffer1 = (unsigned int *)(0x80000000+0x1000000);
volatile unsigned int * FrameBuffer2 = (unsigned int *)(0x80000000+0x2000000);
volatile unsigned int * FrameBuffer3 = (unsigned int *)(0x80000000+0x3000000);
volatile unsigned int * FrameBuffer4 = (unsigned int *)(0x80000000+0x4000000);
volatile unsigned int * FrameBuffer5 = (unsigned int *)(0x80000000+0x5000000);
volatile unsigned int * FrameBuffer6 = (unsigned int *)(0x80000000+0x6000000);
volatile unsigned int * FrameBuffer7 = (unsigned int *)(0x80000000+0x7000000);
volatile unsigned int * FrameBuffer8 = (unsigned int *)(0x80000000+0x7800000);

volatile unsigned int * FrBBaseAddr = (unsigned int *)0x44A00000;
volatile unsigned int * DrBBaseAddr = (unsigned int *)0x44A00004;
volatile unsigned int * DpBBaseAddr = (unsigned int *)0x44A00008;
volatile unsigned int * Ready = 	  (unsigned int *)0x44A0000C;
volatile unsigned int * Done = 		  (unsigned int *)0x44A00010;

volatile unsigned int * TFT = (unsigned int *)0x44A10000;

static XTft TftInstance;

int main()
{
	init_platform();

	// Initialize TFT
	XTft_Config *tft = XTft_LookupConfig(0);
	int status = XTft_CfgInitialize(&TftInstance, tft, tft->BaseAddress);

	FillBuffer(FrameBuffer0,0x00FFF000);
	FillBuffer(FrameBuffer1,0x0000FF00);
	FillBuffer(FrameBuffer2,0x00000000);
	FillBuffer(FrameBuffer3,0x00000000);
	FillBuffer(FrameBuffer4,0x00000FFF);
	FillBuffer(FrameBuffer5,0x00000FFF);
	FillBuffer(FrameBuffer6,0x00F0000F);
	FillBuffer(FrameBuffer7,0x00000000);
	FillBuffer(FrameBuffer8,0x00000FFF);

	Display(FrameBuffer8);
	int x = 0;
	while(1){
		PushLine(FrameBuffer2,x,0xFFFF0000);
		RunComposition(FrameBuffer0,FrameBuffer2,FrameBuffer4);
		Display(FrameBuffer4);

		PushLine(FrameBuffer3,x,0xFFFF0000);
		RunComposition(FrameBuffer1,FrameBuffer3,FrameBuffer5);
		Display(FrameBuffer5);

		PushLine(FrameBuffer7,x,0xFFFF0000);
		RunComposition(FrameBuffer6,FrameBuffer7,FrameBuffer8);
		Display(FrameBuffer8);
		x++;

	}


	return 0;
}

// Sleep for a number of processor cycles
void sleep(int cycles){
	int i;
	for(i=0;i<cycles;i++)
		asm("nop");
}

void FillBuffer(unsigned int * buffer, int colour){
	int i;
	for(i=0;i<(1<<21); i++)
		*(buffer+i)=colour;
}
void Display(unsigned int *buffer){
	*(TFT)=buffer;
}
void PushLine(unsigned int *buffer, int line, int colour){
	int i;
	for(i=0;i<1024*10;i++)
		*(buffer+i+line*1024*10)=colour;
}
void RunComposition(unsigned int *Fr, unsigned int *Dr, unsigned int *Dp){
	*FrBBaseAddr = Fr;
	*DrBBaseAddr = Dr;
	*DpBBaseAddr = Dp;
	*Ready = 1;
	*Ready = 0;
}
/*
void DrawBlob(unsigned int * addr, int x, int y, int colour){
	int xOff,yOff;
	for(xOff=-100;xOff<=100;xOff++){
		for(yOff=-100;yOff<=100;yOff++){
			*(addr+1024*(y+yOff)+(x+xOff)) = colour;
		}
	}
}
/*

#include <stdio.h>
#include "platform.h"
#include "xtft.h"

/************************** Constant Definitions ****************************
#define DISPLAY_COLUMNS  640
#define DISPLAY_ROWS     480

volatile unsigned int * ddr = (unsigned int *)0x80000000;
volatile unsigned int * FrameBuffer0 = (unsigned int *)0x80000000;
volatile unsigned int * FrameBuffer1 = (unsigned int *)0x80000000+0x200000;
volatile unsigned int * FrameBuffer2 = (unsigned int *)0x80000000+0x400000;

volatile unsigned int * FrBBaseAddr = (unsigned int *)0x44A00000;
volatile unsigned int * DrBBaseAddr = (unsigned int *)0x44A00004;
volatile unsigned int * DpBBaseAddr = (unsigned int *)0x44A00008;
volatile unsigned int * Ready = 	  (unsigned int *)0x44A0000C;
volatile unsigned int * Done = 		  (unsigned int *)0x44A00010;

volatile unsigned int * TFT = (unsigned int *)0x44A10000;

static XTft TftInstance;

int main()
{
	init_platform();

	// Initialize TFT
	XTft_Config *tft = XTft_LookupConfig(0);
	int status = XTft_CfgInitialize(&TftInstance, tft, tft->BaseAddress);

	// Change color back and forth to demonstrate double-buffering
	int x,y;
	for(x=0;x<640;x++){
		for(y=0;y<480;y++){
			*(FrameBuffer0+1024*y+x)=0x00fff000;
		}
	}
	for(x=0;x<640;x++){
			for(y=0;y<480;y++){
				*(FrameBuffer2+1024*y+x)=0x00000000;
			}
		}
	//XTft_SetFrameBaseAddr(&TftInstance, (u32)FrameBuffer0);
	*(TFT) = FrameBuffer2;

	for(x=0;x<(1<<21);x++){
		*(FrameBuffer1+x) = 0x00000000;
	}

	unsigned int tester;
	while(1){
		*(FrBBaseAddr) = FrameBuffer0;
		*(DrBBaseAddr) = FrameBuffer1;
		*(DpBBaseAddr) = FrameBuffer2;
		*(Ready) = 1;
		tester = *Ready;
		tester = *Done;
		*(Ready) = 0;
		tester = *Ready;
		sleep(5000000);
		y = x;
		for(;x<(y+(1<<16));x++){
			*(FrameBuffer1+x) = 0xFF000fff;
		}

	}

	return 0;
}

// Sleep for a number of processor cycles
void sleep(int cycles){
	int i;
	for(i=0;i<cycles;i++)
		asm("nop");
}

 */


/*
	// Change color back and forth to demonstrate double-buffering
	int x,y;
	for(x=0;x<640;x++){
		for(y=0;y<480;y++){
			*(FrameBuffer0+1024*y+x)=0x00fff000;
			*(FrameBuffer5+1024*y+x)=0x00fff000;
		}
	}
	for(x=0;x<640;x++){
			for(y=0;y<480;y++){
				*(FrameBuffer2+1024*y+x)=0x00000000;
			}
		}
	//XTft_SetFrameBaseAddr(&TftInstance, (u32)FrameBuffer0);
	*(TFT) = FrameBuffer3;

	for(x=0;x<(1<<21);x++){
		*(FrameBuffer1+x) = 0x00000000;
		*(FrameBuffer4+x)=0x00000000;
	}
	unsigned int tester;
	while(1){
		for(x=0;x<480;x++){
			for(y=0;y<1024;y++){
				*(FrameBuffer1+y+1024*x) = 0xFF00000F;

			}
			*(FrBBaseAddr) = FrameBuffer0;
			*(DrBBaseAddr) = FrameBuffer1;
			*(DpBBaseAddr) = FrameBuffer2;
			*(Ready) = 1;
			*(Ready) = 0;
			*(TFT) = FrameBuffer2;
			x++;
			for(y=0;y<1024;y++){
				*(FrameBuffer4+y+1024*x) = 0xFF00000F;
			}
			*(FrBBaseAddr) = FrameBuffer5;
			*(DrBBaseAddr) = FrameBuffer4;
			*(DpBBaseAddr) = FrameBuffer3;
			*(Ready) = 1;
			*(Ready) = 0;
			*(TFT) = FrameBuffer3;
		}
	}
 */
